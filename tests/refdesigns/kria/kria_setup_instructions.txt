# To be run in sudo mode
sudo su

# Install dependencies
dnf install -y git curl-dev libjsoncpp-dev
#? dnf install -y packagegroup-petalinux-self-hosted
pip3 install backports.entry-points-selectable filelock
pip3 install wheel pyopencl pytest pytest-flask flake8


# Compile DRM library
git clone --recursive https://github.com/Accelize/drm.git -b dev
cd drm
mkdir build
cd build
cmake -DPYTHON3=ON -DTESTS=ON ..
cmake -DPYTHON3=ON -DTESTS=ON -DCMAKE_BUILD_TYPE=Debug ..
make
cd ..

export XILINX_XRT=/usr

# Start test
LD_LIBRARY_PATH=/home/petalinux/drm/build python3 -m pytest --backend=c --cred=../../cred.json --server=dev --fpga_image=fpga-drm-hybrid-adder.som --drm_controller_base_address=0xA0010000 -ra