---
name: DRM Library documentation

trigger:
  branches:
    include:
      - master
      - dev
  paths:
    include:
      # Version definition
      - CMakeLists.txt
      # Sphinx documentation source
      - doc/*
      # C/C++ API documentation generated by Doxygen + Breath
      - include/accelize/drm/drm_manager.h
      - include/accelize/drm/error.h
      - include/accelize/drmc/wrapper.h
      - include/accelize/drmc/errorcode.h
      # Python API documentation generated by Autodoc
      - python/accelize_drm/__init__.py
      - python/accelize_drm/exceptions.py
      - python/src/_accelize_drm.pyx
      - python/src/_accelize_drmc.pyx
pr: none

variables:
  ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/master') }}:
    releaseChannel: stable
  ${{ if ne(variables['Build.SourceBranch'], 'refs/heads/master') }}:
    releaseChannel: prerelease

pool:
  vmImage: ubuntu-20.04

stages:

  - stage:
    displayName: Update documentation
    jobs:
      - job:
        displayName: Update documentation
        steps:

        - script: |
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends doxygen g++ libcurl4-openssl-dev libjsoncpp-dev make pkg-config
            sudo pip install --disable-pip-version-check --no-cache-dir breathe cython sphinx_rtd_theme
          displayName: Install dependencies

        - script: |
            mkdir build_doc
            cd build_doc
            cmake -DPYTHON3=ON -DDOC=ON ..
            make -s -j
          displayName: Build documentation

        - task: AWSCLI@1
          displayName: Publish documentation
          inputs:
            awsCredentials: AWS-Repository
            regionName: eu-west-1
            awsCommand: s3
            awsSubCommand: sync
            awsArguments: build_doc/doc_html
                          s3://accelize/documentation/$(releaseChannel)/
                          --no-progress --delete --acl public-read --size-only
